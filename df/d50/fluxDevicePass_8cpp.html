<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NMSU | Pearl Lab | PPT-GPU: PPT-GPU/llvm_tool/lib/fluxDevicePass.cpp File Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NMSU | Pearl Lab | PPT-GPU
   &#160;<span id="projectnumber">1.2</span>
   </div>
   <div id="projectbrief">PPT-GPU is a scalable and flexible framework to predict the performance of GPUs running general purpose workloads. PPT-GPU can use the virtual (PTX) or the native (SASS) ISAs without sacrificing accuracy, ease of use, or portability. The tool is currently focused on NVIDIA GPUs. We plan to extend our approach to model other vendors&#39; GPUs such as AMD and Intel.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_314b7b0ae7a94aec80f890d054939bbf.html">PPT-GPU</a></li><li class="navelem"><a class="el" href="../../dir_7d6a815a392553a1821bb22282fb703f.html">llvm_tool</a></li><li class="navelem"><a class="el" href="../../dir_f9d65d30b8233027dfbe0b8aeff5b0c8.html">lib</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">fluxDevicePass.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="../../HTML/S/11.html">Mekong-Utils.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="../../HTML/S/20.html">cudaFluxPasses.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="../../HTML/S/18.html">deviceRuntime.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="../../HTML/S/10.html">ptx_parser.h</a>&quot;</code><br />
<code>#include &quot;llvm/Bitcode/BitcodeWriter.h&quot;</code><br />
<code>#include &quot;llvm/IR/Constants.h&quot;</code><br />
<code>#include &quot;llvm/IR/Function.h&quot;</code><br />
<code>#include &quot;llvm/IR/IRBuilder.h&quot;</code><br />
<code>#include &quot;llvm/Pass.h&quot;</code><br />
<code>#include &quot;llvm/Support/raw_ostream.h&quot;</code><br />
<code>#include &quot;llvm/Transforms/Utils/Cloning.h&quot;</code><br />
<code>#include &lt;array&gt;</code><br />
<code>#include &lt;cstdio&gt;</code><br />
<code>#include &lt;fstream&gt;</code><br />
<code>#include &lt;map&gt;</code><br />
<code>#include &lt;memory&gt;</code><br />
<code>#include &lt;stdexcept&gt;</code><br />
<code>#include &lt;string&gt;</code><br />
<code>#include &lt;vector&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for fluxDevicePass.cpp:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../d5/d2d/fluxDevicePass_8cpp__incl.svg" width="100%" height="600"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
</div>
<p><a href="../../HTML/S/26.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a43b669bccb8bce8ea862a58a9dc116bd"><td class="memItemLeft" align="right" valign="top">std::string&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../df/d50/fluxDevicePass_8cpp.html#a43b669bccb8bce8ea862a58a9dc116bd">exec</a> (const char *cmd)</td></tr>
<tr class="separator:a43b669bccb8bce8ea862a58a9dc116bd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2ac711460e8e656c38736b76db7c9e92"><td class="memItemLeft" align="right" valign="top">std::vector&lt; <a class="el" href="../../d3/dcd/namespacemekong.html#d1/df9/structmekong_1_1PTXFunction">mekong::PTXFunction</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../df/d50/fluxDevicePass_8cpp.html#a2ac711460e8e656c38736b76db7c9e92">ptxInstructionAnalysis</a> (Module &amp;M)</td></tr>
<tr class="separator:a2ac711460e8e656c38736b76db7c9e92"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a568ff618d3d2921cd08557e977754030"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../df/d50/fluxDevicePass_8cpp.html#a568ff618d3d2921cd08557e977754030">basicBlockInstrumentation</a> (Module &amp;M, std::vector&lt; <a class="el" href="../../d3/dcd/namespacemekong.html#d1/df9/structmekong_1_1PTXFunction">mekong::PTXFunction</a> &gt; funcVec)</td></tr>
<tr class="separator:a568ff618d3d2921cd08557e977754030"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a568ff618d3d2921cd08557e977754030"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a568ff618d3d2921cd08557e977754030">&#9670;&nbsp;</a></span>basicBlockInstrumentation()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void basicBlockInstrumentation </td>
          <td>(</td>
          <td class="paramtype">Module &amp;&#160;</td>
          <td class="paramname"><em>M</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="../../d3/dcd/namespacemekong.html#d1/df9/structmekong_1_1PTXFunction">mekong::PTXFunction</a> &gt;&#160;</td>
          <td class="paramname"><em>funcVec</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../HTML/S/26.html#L108">108</a> of file <a class="el" href="../../HTML/S/26.html">fluxDevicePass.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;                                                                                {</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160; </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  LLVMContext &amp;ctx = M.getContext();</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160; </div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  <span class="comment">// Get Trace Function</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  Function *traceFun = M.getFunction(<span class="stringliteral">&quot;incBlockCounter_mt_2&quot;</span>);</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <span class="comment">// GetKernels //</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  std::vector&lt;Function *&gt; kernels;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <a class="code" href="../../d3/dcd/namespacemekong.html#a51a6949c9e5f60d1635f94ef386d397f">mekong::getKernels</a>(M, kernels);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160; </div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <span class="comment">// For each Kernel</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keywordflow">for</span> (Function *kernel : kernels) {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    errs() &lt;&lt; <span class="stringliteral">&quot;CUDA Flux: Working on kernel: &quot;</span> + kernel-&gt;getName() + <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="comment">// TODO Check for function calls</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordtype">bool</span> callsFunctions = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160; </div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">// Warn if function calls are made</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">if</span> (callsFunctions)</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      errs() &lt;&lt; <span class="stringliteral">&quot;CUDA Flux: WARNING for kernel &quot;</span> + kernel-&gt;getName() + <span class="stringliteral">&quot;: FunctionCalls are not supported yet!\n&quot;</span>;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160; </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="comment">// Clone Kernel and add Argument : (AMMAR: Adding our counter)</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    std::vector&lt;Type *&gt; args;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    args.push_back(Type::getInt64PtrTy(ctx));</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    args.push_back(Type::getInt64PtrTy(ctx));</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    args.push_back(Type::getInt32Ty(ctx));</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    args.push_back(Type::getInt32Ty(ctx));</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    Function *kernelClone = <a class="code" href="../../d3/dcd/namespacemekong.html#a64c2cc8ef711bb2c9c8c88d992aa9d83">mekong::cloneAndAddArgs</a>(kernel, args, {<span class="stringliteral">&quot;bblist&quot;</span>, <span class="stringliteral">&quot;bblist1&quot;</span>, <span class="stringliteral">&quot;n_banks&quot;</span>, <span class="stringliteral">&quot;profiling_mode&quot;</span>});</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160; </div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <span class="comment">// Assign each block an id</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="comment">// Must be done on the kernel clone otherwise the mapping is of when</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="comment">// instrumenting the basic blocks</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    std::map&lt;BasicBlock *, int&gt; blockIDs = <a class="code" href="../../d3/dcd/namespacemekong.html#a769701c40cf1cb06898926ad2b7e6c6e">mekong::getBlockIDMap</a>(kernelClone, funcVec, kernel-&gt;getName().str());</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <span class="keywordtype">int</span> block_count = 0;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <span class="keywordflow">for</span> (llvm::BasicBlock &amp;bb : kernelClone-&gt;getBasicBlockList()) {</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;      block_count += 1;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    }</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    errs() &lt;&lt; <span class="stringliteral">&quot;CUDA Flux: BlockCount: &quot;</span> &lt;&lt; block_count &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160; </div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="comment">// Get TracePointer (2 before last kernel argument)</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    Value *trace_ptr = &amp;*(kernelClone-&gt;arg_begin() + (kernelClone-&gt;arg_size() - 4));</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    Value *trace_ptr1 = &amp;*(kernelClone-&gt;arg_begin() + (kernelClone-&gt;arg_size() - 3));</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="comment">// Get Number of Banks (before kernel argument)</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    Value *<a class="code" href="../../da/de5/hostRuntime_8cpp.html#a028a3358c3f2275c1688e1cea9318d5a">n_banks</a> = &amp;*(kernelClone-&gt;arg_begin() + (kernelClone-&gt;arg_size() - 2));</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="comment">// Get Profiling Mode (last kernel argument)</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    Value *profiling = &amp;*(kernelClone-&gt;arg_begin() + (kernelClone-&gt;arg_size() - 1));</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160; </div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="comment">// Get IRBuilder</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    IRBuilder&lt;&gt; builder(ctx);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160; </div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;    <a class="code" href="../../d3/dcd/namespacemekong.html#a2bee8720b71bd96acc6e3753b1c21f82afffda6017908e45be45e9f57afa9ca27">Instruction</a> *insertPoint = &amp;*kernelClone-&gt;begin()-&gt;getFirstInsertionPt();</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    insertPoint = insertPoint-&gt;getNextNode();</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    builder.SetInsertPoint(insertPoint);</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160; </div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="comment">// For each BasicBlock</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="keywordflow">for</span> (BasicBlock &amp;bb : kernelClone-&gt;getBasicBlockList()) {</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      builder.SetInsertPoint(&amp;*bb.getFirstInsertionPt());</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      Constant *block_ID = builder.getInt32(blockIDs.at(&amp;bb));</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160; </div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      <span class="comment">// errs() &lt;&lt; *traceFun &lt;&lt; &quot;\n&quot;;</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;      <span class="comment">// errs() &lt;&lt; *trace_ptr &lt;&lt;&quot;\t&quot;&lt;&lt; *block_ID &lt;&lt;&quot;\t&quot;&lt;&lt; *n_banks &lt;&lt; &quot;\n&quot;;</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160; </div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;      <span class="comment">// Increase blockCounter[blockID]</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;      builder.CreateCall(traceFun, {trace_ptr, trace_ptr1, block_ID, <a class="code" href="../../da/de5/hostRuntime_8cpp.html#a028a3358c3f2275c1688e1cea9318d5a">n_banks</a>, profiling});</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    }</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160; </div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="comment">// Add metadata so the device function will become a kernel when assembled</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="comment">// to a binary</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <a class="code" href="../../d3/dcd/namespacemekong.html#a47c4770f047f5adfcc1ba8cc9d673480">mekong::markKernel</a>(M, kernelClone);</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  }</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../df/d50/fluxDevicePass_8cpp_a568ff618d3d2921cd08557e977754030_cgraph.svg" width="600" height="211"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../df/d50/fluxDevicePass_8cpp_a568ff618d3d2921cd08557e977754030_icgraph.svg" width="631" height="43"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="a43b669bccb8bce8ea862a58a9dc116bd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a43b669bccb8bce8ea862a58a9dc116bd">&#9670;&nbsp;</a></span>exec()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::string exec </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>cmd</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../HTML/S/26.html#L25">25</a> of file <a class="el" href="../../HTML/S/26.html">fluxDevicePass.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;                                {</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;  std::array&lt;char, 128&gt; buffer;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  std::string result;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  std::shared_ptr&lt;FILE&gt; pipe(popen(cmd, <span class="stringliteral">&quot;r&quot;</span>), pclose);</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;  <span class="keywordflow">if</span> (!pipe)</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;popen() failed!&quot;</span>);</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;  <span class="keywordflow">while</span> (!feof(pipe.get())) {</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    <span class="keywordflow">if</span> (fgets(buffer.data(), 128, pipe.get()) != <span class="keyword">nullptr</span>)</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;      result += buffer.data();</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;  }</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;  <span class="keywordflow">return</span> result;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../df/d50/fluxDevicePass_8cpp_a43b669bccb8bce8ea862a58a9dc116bd_icgraph.svg" width="100%" height="300"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>

</div>
</div>
<a id="a2ac711460e8e656c38736b76db7c9e92"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2ac711460e8e656c38736b76db7c9e92">&#9670;&nbsp;</a></span>ptxInstructionAnalysis()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::vector&lt;<a class="el" href="../../d3/dcd/namespacemekong.html#d1/df9/structmekong_1_1PTXFunction">mekong::PTXFunction</a>&gt; ptxInstructionAnalysis </td>
          <td>(</td>
          <td class="paramtype">Module &amp;&#160;</td>
          <td class="paramname"><em>M</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="../../HTML/S/26.html#L38">38</a> of file <a class="el" href="../../HTML/S/26.html">fluxDevicePass.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;                                                               {</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  <span class="comment">// Get Module Prefix</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  std::string prefix = <a class="code" href="../../d3/dcd/namespacemekong.html#a4d2a109ee246b5b72d6f02bd022443d0">mekong::getModulePrefix</a>(&amp;M);</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160; </div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  errs() &lt;&lt; <span class="stringliteral">&quot;CUDA Flux: Module prefix: &quot;</span> &lt;&lt; prefix &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160; </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  <span class="comment">// Write IR to file</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  std::string byteCodeFile = prefix + <span class="stringliteral">&quot;.bc&quot;</span>;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  <a class="code" href="../../d3/dcd/namespacemekong.html#a96bab515b21a605171ce9159c92df460">mekong::dumpModuleToFile</a>(M, byteCodeFile);</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160; </div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  <span class="comment">// call llc to get ptx code</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  <span class="comment">// get target processor and target features</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  std::string ptxFile = prefix + <span class="stringliteral">&quot;.ptx&quot;</span>;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  std::vector&lt;Function *&gt; kernels;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <a class="code" href="../../d3/dcd/namespacemekong.html#a51a6949c9e5f60d1635f94ef386d397f">mekong::getKernels</a>(M, kernels);</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  StringRef target_proc;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  StringRef target_features;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="keywordflow">for</span> (Function *kernel : kernels) {</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    target_proc = kernel-&gt;getFnAttribute(<span class="stringliteral">&quot;target-cpu&quot;</span>).getValueAsString();</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    target_features = kernel-&gt;getFnAttribute(<span class="stringliteral">&quot;target-features&quot;</span>).getValueAsString();</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="keywordflow">break</span>; <span class="comment">// assume all kernel have the same attributes</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  }</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160; </div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="comment">// use O2 because at this point all the higher optimizations are already done.</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <span class="comment">// O2 ensures that the kernel is not simplyfied (de-optimized) again</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  std::string llc_cmd =</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;      <span class="stringliteral">&quot;llc -O2 -mcpu=&quot;</span> + target_proc.str() + <span class="stringliteral">&quot; -mattr=&quot;</span> + target_features.str() + <span class="stringliteral">&quot; -o &quot;</span> + ptxFile + <span class="stringliteral">&quot; &quot;</span> + byteCodeFile;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  <a class="code" href="../../df/d50/fluxDevicePass_8cpp.html#a43b669bccb8bce8ea862a58a9dc116bd">exec</a>(llc_cmd.c_str());</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; </div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  <span class="comment">// parse ptx and write to file</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  std::string outputFile = prefix + <span class="stringliteral">&quot;.out&quot;</span>;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  <span class="keyword">auto</span> tokenVec = <a class="code" href="../../d3/dcd/namespacemekong.html#a3b07cd56e0e49b51928468d8b403d04d">mekong::lexicalAnalysis</a>(ptxFile);</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="keyword">auto</span> funcVec = <a class="code" href="../../d3/dcd/namespacemekong.html#a2ffe7a5f9b1a44da5f20c80b3fc39c0c">mekong::parse</a>(tokenVec);</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160; </div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="comment">// Write PTX Analysis to File</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <span class="comment">// do this befor asserting congruent basic blocks</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  <span class="comment">// for easier debugging</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  {</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    std::ofstream outfileM(outputFile, std::ios::binary);</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160; </div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">auto</span> func : funcVec) {</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;      <span class="comment">// Making out file for every kernel and writing its ptx instructions to it</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;      std::string outputFile = func.name + <span class="stringliteral">&quot;.out&quot;</span>;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      std::ofstream <a class="code" href="../../da/de5/hostRuntime_8cpp.html#a5cea9cb5a5e08d11f5e41f8ca34d9e53">outfile</a>(outputFile, std::ios::binary);</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;      outfileM &lt;&lt; <span class="stringliteral">&quot;- Function:\n&quot;</span>;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;      outfileM &lt;&lt; <span class="stringliteral">&quot;  Name: &quot;</span> &lt;&lt; func.name &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;      outfileM &lt;&lt; <span class="stringliteral">&quot;  BlockCount: &quot;</span> &lt;&lt; func.bb.size() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;      outfileM &lt;&lt; <span class="stringliteral">&quot;  Blocks: \n&quot;</span>;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;      <span class="keywordflow">for</span> (<span class="keyword">auto</span> bb : func.bb) {</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <a class="code" href="../../da/de5/hostRuntime_8cpp.html#a5cea9cb5a5e08d11f5e41f8ca34d9e53">outfile</a> &lt;&lt; <span class="stringliteral">&quot;--\n&quot;</span>;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        outfileM &lt;&lt; <span class="stringliteral">&quot;  - &quot;</span> &lt;&lt; bb.name &lt;&lt; <span class="stringliteral">&quot;:\n&quot;</span>;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;        <span class="keywordflow">for</span> (<span class="keyword">auto</span> inst : bb.inst) {</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;          <a class="code" href="../../da/de5/hostRuntime_8cpp.html#a5cea9cb5a5e08d11f5e41f8ca34d9e53">outfile</a> &lt;&lt; inst &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;          outfileM &lt;&lt; <span class="stringliteral">&quot;    - &quot;</span> &lt;&lt; inst &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;        }</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;      }</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    }</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  }</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160; </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <span class="comment">// Get Register Usage</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  {</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    <span class="comment">// errs() &lt;&lt; &quot;Parsing Register Usage...\n&quot;;</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="comment">// TODO path will not work if not already installed. this will fail when</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    <span class="comment">// testing std::string python_cmd = &quot;parseRegisterUsage.py &quot; + ptxFile + &quot; &quot;</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="comment">// + outputFile; exec(python_cmd.c_str());</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  }</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <span class="keywordflow">return</span> funcVec;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="../../df/d50/fluxDevicePass_8cpp_a2ac711460e8e656c38736b76db7c9e92_cgraph.svg" width="100%" height="584"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../df/d50/fluxDevicePass_8cpp_a2ac711460e8e656c38736b76db7c9e92_icgraph.svg" width="591" height="43"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
</div><!-- contents -->
<div class="ttc" id="anamespacemekong_html_a2bee8720b71bd96acc6e3753b1c21f82afffda6017908e45be45e9f57afa9ca27"><div class="ttname"><a href="../../d3/dcd/namespacemekong.html#a2bee8720b71bd96acc6e3753b1c21f82afffda6017908e45be45e9f57afa9ca27">mekong::Instruction</a></div><div class="ttdeci">@ Instruction</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/10.html#L48">ptx_parser.h:48</a></div></div>
<div class="ttc" id="anamespacemekong_html_a2ffe7a5f9b1a44da5f20c80b3fc39c0c"><div class="ttname"><a href="../../d3/dcd/namespacemekong.html#a2ffe7a5f9b1a44da5f20c80b3fc39c0c">mekong::parse</a></div><div class="ttdeci">std::vector&lt; PTXFunction &gt; parse(std::vector&lt; Token &gt; tokenVec)</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/10.html#L3211">ptx_parser.h:3211</a></div></div>
<div class="ttc" id="anamespacemekong_html_a3b07cd56e0e49b51928468d8b403d04d"><div class="ttname"><a href="../../d3/dcd/namespacemekong.html#a3b07cd56e0e49b51928468d8b403d04d">mekong::lexicalAnalysis</a></div><div class="ttdeci">std::vector&lt; Token &gt; lexicalAnalysis(std::string filename)</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/10.html#L70">ptx_parser.h:70</a></div></div>
<div class="ttc" id="anamespacemekong_html_a64c2cc8ef711bb2c9c8c88d992aa9d83"><div class="ttname"><a href="../../d3/dcd/namespacemekong.html#a64c2cc8ef711bb2c9c8c88d992aa9d83">mekong::cloneAndAddArgs</a></div><div class="ttdeci">llvm::Function * cloneAndAddArgs(llvm::Function *source, std::vector&lt; llvm::Type * &gt; argType, std::vector&lt; std::string &gt; name)</div><div class="ttdoc">===---------------------------------------------------------------—===// Transformation Functions ===...</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/8.html#L40">DeviceUtils.cpp:40</a></div></div>
<div class="ttc" id="anamespacemekong_html_a4d2a109ee246b5b72d6f02bd022443d0"><div class="ttname"><a href="../../d3/dcd/namespacemekong.html#a4d2a109ee246b5b72d6f02bd022443d0">mekong::getModulePrefix</a></div><div class="ttdeci">std::string getModulePrefix(llvm::Module *m)</div><div class="ttdoc">===---------------------------------------------------------------—===// Utility Functions ===-------...</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/5.html#L18">IRUtils.cpp:18</a></div></div>
<div class="ttc" id="ahostRuntime_8cpp_html_a5cea9cb5a5e08d11f5e41f8ca34d9e53"><div class="ttname"><a href="../../da/de5/hostRuntime_8cpp.html#a5cea9cb5a5e08d11f5e41f8ca34d9e53">outfile</a></div><div class="ttdeci">ifstream outfile(string(kernelname)+&quot;.out&quot;)</div></div>
<div class="ttc" id="afluxDevicePass_8cpp_html_a43b669bccb8bce8ea862a58a9dc116bd"><div class="ttname"><a href="../../df/d50/fluxDevicePass_8cpp.html#a43b669bccb8bce8ea862a58a9dc116bd">exec</a></div><div class="ttdeci">std::string exec(const char *cmd)</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/26.html#L25">fluxDevicePass.cpp:25</a></div></div>
<div class="ttc" id="ahostRuntime_8cpp_html_a028a3358c3f2275c1688e1cea9318d5a"><div class="ttname"><a href="../../da/de5/hostRuntime_8cpp.html#a028a3358c3f2275c1688e1cea9318d5a">n_banks</a></div><div class="ttdeci">void uint64_t size_t uint32_t n_banks</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/25.html#L93">hostRuntime.cpp:93</a></div></div>
<div class="ttc" id="anamespacemekong_html_a47c4770f047f5adfcc1ba8cc9d673480"><div class="ttname"><a href="../../d3/dcd/namespacemekong.html#a47c4770f047f5adfcc1ba8cc9d673480">mekong::markKernel</a></div><div class="ttdeci">void markKernel(llvm::Module &amp;m, llvm::Function *kernel)</div><div class="ttdoc">Adds metadata to the current module that will make the given function callable as kernel.</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/8.html#L105">DeviceUtils.cpp:105</a></div></div>
<div class="ttc" id="anamespacemekong_html_a96bab515b21a605171ce9159c92df460"><div class="ttname"><a href="../../d3/dcd/namespacemekong.html#a96bab515b21a605171ce9159c92df460">mekong::dumpModuleToFile</a></div><div class="ttdeci">void dumpModuleToFile(llvm::Module &amp;m, std::string filepath)</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/5.html#L67">IRUtils.cpp:67</a></div></div>
<div class="ttc" id="anamespacemekong_html_a769701c40cf1cb06898926ad2b7e6c6e"><div class="ttname"><a href="../../d3/dcd/namespacemekong.html#a769701c40cf1cb06898926ad2b7e6c6e">mekong::getBlockIDMap</a></div><div class="ttdeci">std::map&lt; llvm::BasicBlock *, int &gt; getBlockIDMap(llvm::Function *func, std::vector&lt; mekong::PTXFunction &gt; funcVec, std::string originalFunctionName)</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/5.html#L44">IRUtils.cpp:44</a></div></div>
<div class="ttc" id="anamespacemekong_html_a51a6949c9e5f60d1635f94ef386d397f"><div class="ttname"><a href="../../d3/dcd/namespacemekong.html#a51a6949c9e5f60d1635f94ef386d397f">mekong::getKernels</a></div><div class="ttdeci">void getKernels(llvm::Module &amp;m, std::vector&lt; llvm::Function * &gt; &amp;kernels)</div><div class="ttdoc">===---------------------------------------------------------------—===// Analysis Functions ===------...</div><div class="ttdef"><b>Definition:</b> <a href="../../HTML/S/8.html#L16">DeviceUtils.cpp:16</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Mar 11 2022 13:38:11 for NMSU | Pearl Lab | PPT-GPU by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
